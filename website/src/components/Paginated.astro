---
// Paginated.astro — viewport-height pages with nav chips
// Wraps child <section> elements as full-viewport slides.
// Long sections get split into actual separate pages.
// Number buttons on the right side for multi-page content.

interface Props {
  pageGroup?: string;
  pageIndex?: number;
}

const { pageGroup = '', pageIndex = 0 } = Astro.props;
---

<div class="paginated" id="paginated" data-page-group={pageGroup} data-page-index={pageIndex}>
  <nav class="paginated__chips">
    <a href="/" class="pg-chip pg-chip--home">Skills</a>
    <a href="/installation" class="pg-chip">Install</a>
    <a href="/tools" class="pg-chip">Tools</a>
    <a href="/faq" class="pg-chip">FAQ</a>
    <a href="/about" class="pg-chip">About</a>
    <a href="/visuals" class="pg-chip">Visuals</a>
    <button class="pg-chip pg-github" data-url="https://github.com/benjam3n/reasoningtool">GitHub</button>
  </nav>
  <div class="paginated__body">
    <div class="paginated__slides">
      <slot />
    </div>
    <div class="paginated__page-nums" id="pg-nums"></div>
  </div>
</div>

<style>
  :global(body) {
    overflow: hidden;
    height: 100vh;
  }

  .paginated {
    position: fixed;
    inset: 0;
    overflow: hidden;
    background: var(--color-bg);
    display: flex;
    flex-direction: column;
  }

  .paginated__chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35em;
    padding: var(--sp-2) var(--sp-3);
    flex-shrink: 0;
    position: relative;
    z-index: 10;
  }

  .pg-chip {
    display: inline-block;
    padding: 0.3em 0.7em;
    border: 1px solid var(--color-accent);
    border-radius: 4px;
    font-family: var(--font-sans);
    font-size: var(--text-xs);
    font-weight: 500;
    text-decoration: none;
    color: var(--color-accent);
    background: var(--color-accent-subtle);
    transition: background var(--transition), color var(--transition);
    cursor: pointer;
  }

  .pg-chip:hover {
    background: var(--color-accent);
    color: #fff;
    text-decoration: none;
  }

  .pg-chip--home {
    border-color: var(--color-accent);
    color: var(--color-accent);
    background: var(--color-accent-subtle);
  }

  .pg-chip--home:hover {
    background: var(--color-accent);
    color: #fff;
  }

  .paginated__body {
    flex: 1;
    min-height: 0;
    display: flex;
    position: relative;
  }

  .paginated__slides {
    flex: 1;
    min-width: 0;
    position: relative;
  }

  .paginated__slides :global(section) {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    display: none;
    padding: var(--sp-2) var(--sp-5);
    padding-bottom: var(--sp-3);
    box-sizing: border-box;
  }

  .paginated__slides :global(section.active) {
    display: block;
  }

  .paginated__page-nums {
    display: flex;
    flex-direction: column;
    gap: 0.4em;
    padding: var(--sp-2) var(--sp-2);
    flex-shrink: 0;
    z-index: 20;
  }

  .paginated__page-nums :global(.pg-num) {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 3rem;
    height: 3rem;
    border: 1px solid var(--color-border);
    border-radius: 6px;
    font-family: var(--font-mono);
    font-size: var(--text-lg);
    font-weight: 600;
    color: var(--color-text-muted);
    background: var(--color-surface);
    cursor: pointer;
    transition: background var(--transition), color var(--transition), border-color var(--transition);
    user-select: none;
  }

  .paginated__page-nums :global(.pg-num:hover) {
    color: var(--color-accent);
    border-color: var(--color-accent);
  }

  .paginated__page-nums :global(.pg-num--active) {
    background: var(--color-accent);
    color: #fff;
    border-color: var(--color-accent);
  }

  /* Content card grid */
  .paginated__slides :global(.content-card-grid) {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-auto-rows: min-content;
    gap: var(--sp-2);
    width: 100%;
    align-items: start;
    align-content: start;
    height: auto !important;
  }

  .paginated__slides :global(.content-card) {
    background: var(--color-surface);
    border: 1px solid var(--color-border-light);
    border-radius: 10px;
    padding: var(--sp-2) var(--sp-3);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04), 0 0 0 1px rgba(0, 0, 0, 0.03);
    overflow: visible;
    box-sizing: border-box;
    font-size: var(--text-xs);
    line-height: 1.45;
  }

  .paginated__slides :global(.content-card h2) {
    margin-top: 0 !important;
    font-size: var(--text-base) !important;
    margin-bottom: var(--sp-1) !important;
  }

  .paginated__slides :global(.content-card h3) {
    margin-top: 0 !important;
    font-size: var(--text-sm) !important;
    margin-bottom: var(--sp-1) !important;
  }

  .paginated__slides :global(.content-card > :last-child) {
    margin-bottom: 0 !important;
  }

  .paginated__slides :global(.content-card p) {
    margin-top: var(--sp-1) !important;
    margin-bottom: var(--sp-1) !important;
  }

  .paginated__slides :global(.content-card ul),
  .paginated__slides :global(.content-card ol) {
    margin-top: var(--sp-1) !important;
    margin-bottom: var(--sp-1) !important;
    padding-left: 1.2em;
  }

  .paginated__slides :global(.content-card table) {
    font-size: var(--text-xs);
  }

  .paginated__slides :global(.content-card pre) {
    font-size: 0.75rem;
    overflow: hidden;
  }
</style>

<script>
  const PAGE_GROUPS: Record<string, string[]> = {
    info: ['/installation', '/tools', '/faq', '/about'],
    visual: ['/', '/visuals'],
  };

  document.addEventListener('astro:page-load', () => {
    const container = document.getElementById('paginated');
    if (!container) return;

    const slidesWrap = container.querySelector('.paginated__slides');
    if (!slidesWrap) return;

    // If CardPaginator is present, wait for it to finish building sections
    const hasCardPaginator = !!slidesWrap.querySelector('[data-card-paginator]');
    if (hasCardPaginator) {
      document.addEventListener('card-paginator:done', () => initNav(container, slidesWrap as HTMLElement), { once: true });
    } else {
      initNav(container, slidesWrap as HTMLElement);
    }
  });

  function initNav(container: HTMLElement, slidesWrap: HTMLElement) {
    const group = container.dataset.pageGroup || '';
    const pages = PAGE_GROUPS[group] || [];
    const pageIndex = parseInt(container.dataset.pageIndex || '0', 10);

    const finalSections = Array.from(slidesWrap.querySelectorAll(':scope > section')) as HTMLElement[];
    if (finalSections.length === 0) return;

    let current = 0;
    const total = finalSections.length;

    // Build number buttons
    const numsContainer = document.getElementById('pg-nums');
    if (numsContainer) numsContainer.innerHTML = '';
    const numBtns: HTMLButtonElement[] = [];

    if (numsContainer && total > 1) {
      for (let i = 0; i < total; i++) {
        const btn = document.createElement('button');
        btn.className = 'pg-num';
        btn.textContent = String(i + 1);
        btn.addEventListener('click', () => show(i));
        numsContainer.appendChild(btn);
        numBtns.push(btn);
      }
    } else if (numsContainer) {
      numsContainer.style.display = 'none';
    }

    function updateNums() {
      numBtns.forEach((btn, i) => {
        btn.classList.toggle('pg-num--active', i === current);
      });
    }

    function show(index: number) {
      if (index < 0 || index >= total) return;
      finalSections.forEach((s) => s.classList.remove('active'));
      finalSections[index].classList.add('active');
      current = index;
      updateNums();
    }

    function goNextPage() {
      if (pages.length === 0) return;
      const nextIndex = (pageIndex + 1) % pages.length;
      window.location.href = pages[nextIndex];
    }

    function goPrevPage() {
      if (pages.length === 0) return;
      const prevIndex = (pageIndex - 1 + pages.length) % pages.length;
      window.location.href = pages[prevIndex];
    }

    function next() {
      if (current < total - 1) show(current + 1);
      else goNextPage();
    }

    function prev() {
      if (current > 0) show(current - 1);
      else goPrevPage();
    }

    // Initialize
    show(0);

    // Keyboard navigation
    document.addEventListener('keydown', (e: KeyboardEvent) => {
      if (e.key === 'ArrowRight' || e.key === ' ') { e.preventDefault(); next(); }
      if (e.key === 'ArrowLeft') { e.preventDefault(); prev(); }
    });

    // GitHub toggle buttons — first click arms, second click opens
    document.querySelectorAll('.pg-github').forEach((btn) => {
      const el = btn as HTMLElement;
      const url = el.dataset.url || 'https://github.com/benjam3n/reasoningtool';
      const originalText = el.textContent || 'GitHub';
      let armed = false;

      el.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (armed) {
          window.open(url, '_blank', 'noopener');
          el.textContent = originalText;
          armed = false;
        } else {
          el.textContent = 'Go to GitHub';
          armed = true;
        }
      });

      document.addEventListener('click', () => {
        if (armed) {
          el.textContent = originalText;
          armed = false;
        }
      });
    });

    // Prevent all scroll events globally
    window.addEventListener('wheel', (e) => { e.preventDefault(); }, { passive: false });
    window.addEventListener('touchmove', (e) => { e.preventDefault(); }, { passive: false });
  }
</script>
