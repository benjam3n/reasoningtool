---
// Paginated.astro — click-to-advance pagination for viewport-height slides
// Wraps child <section> elements as full-viewport slides.
// Click right half → next, left half → prev. Arrow keys work too.
import Header from './Header.astro';

interface Props {
  activeNav?: string;
}

const { activeNav = '' } = Astro.props;
---

<Header activeNav={activeNav} />

<div class="paginated" id="paginated">
  <div class="paginated__slides">
    <slot />
  </div>
  <div class="paginated__nav">
    <button class="paginated__arrow paginated__arrow--prev" id="pg-prev" aria-label="Previous slide">&larr;</button>
    <span class="paginated__indicator" id="pg-indicator">1 / 1</span>
    <button class="paginated__arrow paginated__arrow--next" id="pg-next" aria-label="Next slide">&rarr;</button>
  </div>
</div>

<style>
  .paginated {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    overflow: hidden;
    background: var(--color-bg);
  }

  .paginated__slides {
    width: 100%;
    height: 100%;
    position: relative;
  }

  .paginated__slides :global(section) {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    overflow-y: auto;
    display: none;
    padding: var(--sp-5) var(--sp-4);
    padding-bottom: 4rem;
    box-sizing: border-box;
  }

  .paginated__slides :global(section.active) {
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  /* Constrain content width within slides */
  .paginated__slides :global(section > *) {
    max-width: var(--width-page);
    margin-left: auto;
    margin-right: auto;
    width: 100%;
  }

  .paginated__nav {
    position: fixed;
    bottom: var(--sp-4);
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: var(--sp-3);
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: 999px;
    padding: var(--sp-1) var(--sp-3);
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    z-index: 1000;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    user-select: none;
  }

  .paginated__arrow {
    background: none;
    border: none;
    color: var(--color-text-muted);
    cursor: pointer;
    font-size: var(--text-sm);
    padding: var(--sp-1) var(--sp-2);
    border-radius: 4px;
    transition: color var(--transition), background var(--transition);
    font-family: var(--font-sans);
    line-height: 1;
  }

  .paginated__arrow:hover {
    color: var(--color-text);
    background: var(--color-bg-secondary);
  }

  .paginated__arrow:disabled {
    opacity: 0.25;
    cursor: default;
  }

  .paginated__arrow:disabled:hover {
    background: none;
    color: var(--color-text-muted);
  }

  .paginated__indicator {
    min-width: 3em;
    text-align: center;
  }
</style>

<script>
  document.addEventListener('astro:page-load', () => {
    const container = document.getElementById('paginated');
    if (!container) return;

    // Position paginated area below the nav bar
    const nav = document.querySelector('.nav') as HTMLElement;
    if (nav) {
      const navHeight = nav.offsetHeight;
      container.style.top = navHeight + 'px';
    }

    const slidesWrap = container.querySelector('.paginated__slides');
    if (!slidesWrap) return;

    const sections = Array.from(slidesWrap.querySelectorAll(':scope > section'));
    if (sections.length === 0) return;

    let current = 0;
    const total = sections.length;

    const indicator = document.getElementById('pg-indicator');
    const prevBtn = document.getElementById('pg-prev') as HTMLButtonElement;
    const nextBtn = document.getElementById('pg-next') as HTMLButtonElement;

    // Hide pagination controls if only one slide
    const pgNav = container.querySelector('.paginated__nav') as HTMLElement;
    if (total <= 1 && pgNav) {
      pgNav.style.display = 'none';
    }

    function show(index: number) {
      if (index < 0 || index >= total) return;
      sections.forEach((s, i) => {
        s.classList.toggle('active', i === index);
      });
      current = index;
      if (indicator) indicator.textContent = `${current + 1} / ${total}`;
      if (prevBtn) prevBtn.disabled = current === 0;
      if (nextBtn) nextBtn.disabled = current === total - 1;
    }

    function next() { if (current < total - 1) show(current + 1); }
    function prev() { if (current > 0) show(current - 1); }

    // Initialize
    show(0);

    // Click navigation — right half next, left half prev
    slidesWrap.addEventListener('click', (e: Event) => {
      const me = e as MouseEvent;
      const target = me.target as HTMLElement;
      // Don't intercept clicks on links, buttons, code, details, summary
      if (target.closest('a, button, details, summary, pre, code, input, textarea, select')) return;
      const rect = slidesWrap.getBoundingClientRect();
      const x = me.clientX - rect.left;
      if (x > rect.width / 2) {
        next();
      } else {
        prev();
      }
    });

    // Button navigation
    if (prevBtn) prevBtn.addEventListener('click', (e) => { e.stopPropagation(); prev(); });
    if (nextBtn) nextBtn.addEventListener('click', (e) => { e.stopPropagation(); next(); });

    // Keyboard navigation
    document.addEventListener('keydown', (e: KeyboardEvent) => {
      if (e.key === 'ArrowRight' || e.key === ' ') { e.preventDefault(); next(); }
      if (e.key === 'ArrowLeft') { e.preventDefault(); prev(); }
    });
  });
</script>
