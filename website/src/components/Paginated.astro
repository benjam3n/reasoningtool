---
// Paginated.astro â€” viewport-height slides with nav chips
// Wraps child <section> elements as full-viewport slides.
// Arrow keys navigate between slides. Nav chips always visible at top.

interface Props {
  pageGroup?: string;
  pageIndex?: number;
}

const { pageGroup = '', pageIndex = 0 } = Astro.props;
---

<div class="paginated" id="paginated" data-page-group={pageGroup} data-page-index={pageIndex}>
  <nav class="paginated__chips">
    <a href="/" class="pg-chip pg-chip--home">Home</a>
    <a href="/installation" class="pg-chip">Install</a>
    <a href="/why" class="pg-chip">Why</a>
    <a href="/tools" class="pg-chip">Tools</a>
    <a href="/faq" class="pg-chip">FAQ</a>
    <a href="/about" class="pg-chip">About</a>
    <a href="/visuals" class="pg-chip">Visuals</a>
    <a href="/github" class="pg-chip">GitHub</a>
  </nav>
  <div class="paginated__slides">
    <slot />
  </div>
</div>

<style>
  :global(body) {
    overflow: hidden;
    height: 100vh;
  }

  .paginated {
    position: fixed;
    inset: 0;
    overflow: hidden;
    background: var(--color-bg);
    display: flex;
    flex-direction: column;
  }

  .paginated__chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35em;
    padding: var(--sp-2) var(--sp-3);
    flex-shrink: 0;
    position: relative;
    z-index: 10;
  }

  .pg-chip {
    display: inline-block;
    padding: 0.3em 0.7em;
    border: 1px solid var(--color-accent);
    border-radius: 4px;
    font-family: var(--font-sans);
    font-size: var(--text-xs);
    font-weight: 500;
    text-decoration: none;
    color: var(--color-accent);
    background: var(--color-accent-subtle);
    transition: background var(--transition), color var(--transition);
    cursor: pointer;
  }

  .pg-chip:hover {
    background: var(--color-accent);
    color: #fff;
    text-decoration: none;
  }

  .pg-chip--home {
    border-color: var(--color-text-muted);
    color: var(--color-text-muted);
    background: transparent;
  }

  .pg-chip--home:hover {
    background: var(--color-text-muted);
    color: var(--color-bg);
  }

  .paginated__slides {
    width: 100%;
    flex: 1;
    min-height: 0;
    position: relative;
  }

  .paginated__slides :global(section) {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    display: none;
    padding: var(--sp-2) var(--sp-5);
    padding-bottom: var(--sp-3);
    box-sizing: border-box;
  }

  .paginated__slides :global(section.active) {
    display: block;
  }

  /* Inner wrapper for virtual scroll on overflow sections */
</style>

<script>
  const PAGE_GROUPS: Record<string, string[]> = {
    info: ['/installation', '/why', '/tools', '/faq', '/about'],
    visual: ['/', '/visuals'],
  };

  document.addEventListener('astro:page-load', () => {
    const container = document.getElementById('paginated');
    if (!container) return;

    const group = container.dataset.pageGroup || '';
    const pages = PAGE_GROUPS[group] || [];
    const pageIndex = parseInt(container.dataset.pageIndex || '0', 10);

    const slidesWrap = container.querySelector('.paginated__slides');
    if (!slidesWrap) return;

    const sections = Array.from(slidesWrap.querySelectorAll(':scope > section'));
    if (sections.length === 0) return;

    // Build a flat list of "virtual slides"
    // Each section that overflows gets multiple virtual pages
    interface VSlide {
      section: HTMLElement;
      scrollOffset: number;  // translateY offset for this virtual page
    }

    const vSlides: VSlide[] = [];

    // Temporarily show each section to measure content height
    sections.forEach((sec) => {
      const s = sec as HTMLElement;
      const prevDisplay = s.style.display;
      s.style.display = 'block';
      s.classList.add('active');

      // Wrap content in a scroll-inner div if not already
      let inner = s.querySelector('.pg-scroll-inner') as HTMLElement;
      if (!inner) {
        inner = document.createElement('div');
        inner.className = 'pg-scroll-inner';
        while (s.firstChild) {
          inner.appendChild(s.firstChild);
        }
        s.appendChild(inner);
      }

      const viewportHeight = s.clientHeight;
      const contentHeight = inner.scrollHeight;

      if (contentHeight <= viewportHeight) {
        // Fits in one page
        vSlides.push({ section: s, scrollOffset: 0 });
      } else {
        // Needs multiple virtual pages
        let offset = 0;
        while (offset < contentHeight) {
          vSlides.push({ section: s, scrollOffset: offset });
          offset += viewportHeight;
        }
      }

      s.style.display = prevDisplay;
      s.classList.remove('active');
    });

    let current = 0;
    const total = vSlides.length;

    function show(index: number) {
      if (index < 0 || index >= total) return;
      const slide = vSlides[index];

      // Hide all sections, show the one for this virtual slide
      sections.forEach((s) => s.classList.remove('active'));
      slide.section.classList.add('active');

      // Apply scroll offset
      const inner = slide.section.querySelector('.pg-scroll-inner') as HTMLElement;
      if (inner) {
        inner.style.transform = `translateY(-${slide.scrollOffset}px)`;
      }

      current = index;
    }

    function goNextPage() {
      if (pages.length === 0) return;
      const nextIndex = (pageIndex + 1) % pages.length;
      window.location.href = pages[nextIndex];
    }

    function goPrevPage() {
      if (pages.length === 0) return;
      const prevIndex = (pageIndex - 1 + pages.length) % pages.length;
      window.location.href = pages[prevIndex];
    }

    function next() {
      if (current < total - 1) {
        show(current + 1);
      } else {
        goNextPage();
      }
    }

    function prev() {
      if (current > 0) {
        show(current - 1);
      } else {
        goPrevPage();
      }
    }

    // Initialize
    show(0);

    // Keyboard navigation
    document.addEventListener('keydown', (e: KeyboardEvent) => {
      if (e.key === 'ArrowRight' || e.key === ' ') { e.preventDefault(); next(); }
      if (e.key === 'ArrowLeft') { e.preventDefault(); prev(); }
    });

    // Prevent all scroll events globally
    window.addEventListener('wheel', (e) => { e.preventDefault(); }, { passive: false });
    window.addEventListener('touchmove', (e) => { e.preventDefault(); }, { passive: false });
  });
</script>
