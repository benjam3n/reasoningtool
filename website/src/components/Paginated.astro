---
// Paginated.astro — viewport-height pages with nav chips
// Wraps child <section> elements as full-viewport slides.
// Long sections get split into actual separate pages.
// Number buttons on the right side for multi-page content.

interface Props {
  pageGroup?: string;
  pageIndex?: number;
}

const { pageGroup = '', pageIndex = 0 } = Astro.props;
---

<div class="paginated" id="paginated" data-page-group={pageGroup} data-page-index={pageIndex}>
  <nav class="paginated__chips">
    <a href="/" class="pg-chip pg-chip--home">Skills</a>
    <a href="/installation" class="pg-chip">Install</a>
    <a href="/tools" class="pg-chip">Tools</a>
    <a href="/faq" class="pg-chip">FAQ</a>
    <a href="/about" class="pg-chip">About</a>
    <a href="/visuals" class="pg-chip">Visuals</a>
    <a href="/github" class="pg-chip">GitHub</a>
  </nav>
  <div class="paginated__body">
    <div class="paginated__slides">
      <slot />
    </div>
    <div class="paginated__page-nums" id="pg-nums"></div>
  </div>
</div>

<style>
  :global(body) {
    overflow: hidden;
    height: 100vh;
  }

  .paginated {
    position: fixed;
    inset: 0;
    overflow: hidden;
    background: var(--color-bg);
    display: flex;
    flex-direction: column;
  }

  .paginated__chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35em;
    padding: var(--sp-2) var(--sp-3);
    flex-shrink: 0;
    position: relative;
    z-index: 10;
  }

  .pg-chip {
    display: inline-block;
    padding: 0.3em 0.7em;
    border: 1px solid var(--color-accent);
    border-radius: 4px;
    font-family: var(--font-sans);
    font-size: var(--text-xs);
    font-weight: 500;
    text-decoration: none;
    color: var(--color-accent);
    background: var(--color-accent-subtle);
    transition: background var(--transition), color var(--transition);
    cursor: pointer;
  }

  .pg-chip:hover {
    background: var(--color-accent);
    color: #fff;
    text-decoration: none;
  }

  .pg-chip--home {
    border-color: var(--color-text-muted);
    color: var(--color-text-muted);
    background: transparent;
  }

  .pg-chip--home:hover {
    background: var(--color-text-muted);
    color: var(--color-bg);
  }

  .paginated__body {
    flex: 1;
    min-height: 0;
    display: flex;
    position: relative;
  }

  .paginated__slides {
    flex: 1;
    min-width: 0;
    position: relative;
  }

  .paginated__slides :global(section) {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
    display: none;
    padding: var(--sp-2) var(--sp-5);
    padding-bottom: var(--sp-3);
    box-sizing: border-box;
  }

  .paginated__slides :global(section.active) {
    display: block;
  }

  .paginated__page-nums {
    display: flex;
    flex-direction: column;
    gap: 0.4em;
    padding: var(--sp-2) var(--sp-2);
    flex-shrink: 0;
    z-index: 20;
  }

  .paginated__page-nums :global(.pg-num) {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 3rem;
    height: 3rem;
    border: 1px solid var(--color-border);
    border-radius: 6px;
    font-family: var(--font-mono);
    font-size: var(--text-lg);
    font-weight: 600;
    color: var(--color-text-muted);
    background: var(--color-surface);
    cursor: pointer;
    transition: background var(--transition), color var(--transition), border-color var(--transition);
    user-select: none;
  }

  .paginated__page-nums :global(.pg-num:hover) {
    color: var(--color-accent);
    border-color: var(--color-accent);
  }

  .paginated__page-nums :global(.pg-num--active) {
    background: var(--color-accent);
    color: #fff;
    border-color: var(--color-accent);
  }
</style>

<script>
  const PAGE_GROUPS: Record<string, string[]> = {
    info: ['/installation', '/tools', '/faq', '/about'],
    visual: ['/', '/visuals'],
  };

  document.addEventListener('astro:page-load', () => {
    const container = document.getElementById('paginated');
    if (!container) return;

    const group = container.dataset.pageGroup || '';
    const pages = PAGE_GROUPS[group] || [];
    const pageIndex = parseInt(container.dataset.pageIndex || '0', 10);

    const slidesWrap = container.querySelector('.paginated__slides');
    if (!slidesWrap) return;

    const sections = Array.from(slidesWrap.querySelectorAll(':scope > section'));
    if (sections.length === 0) return;

    // Split long sections into multiple real pages by moving child elements
    const allPages: HTMLElement[] = [];

    sections.forEach((sec) => {
      const s = sec as HTMLElement;

      // Temporarily show to measure
      s.style.display = 'block';
      s.classList.add('active');
      const viewportHeight = s.clientHeight;

      // Get all direct children
      const children = Array.from(s.children) as HTMLElement[];

      // Check if content fits
      if (s.scrollHeight <= viewportHeight) {
        s.style.display = '';
        s.classList.remove('active');
        allPages.push(s);
        return;
      }

      // Need to split — create pages by moving children
      s.style.display = '';
      s.classList.remove('active');

      let currentPage = s;
      // Remove all children from the original section first
      children.forEach(child => child.remove());

      // Re-add children, creating new sections when overflow occurs
      children.forEach((child) => {
        currentPage.appendChild(child);

        // Temporarily show to measure
        const wasActive = currentPage.classList.contains('active');
        currentPage.style.display = 'block';
        currentPage.classList.add('active');

        if (currentPage.scrollHeight > viewportHeight && currentPage.children.length > 1) {
          // This child caused overflow — move it to a new page
          child.remove();
          currentPage.style.display = '';
          if (!wasActive) currentPage.classList.remove('active');

          // Create new section
          const newPage = document.createElement('section');
          // Copy classes from original
          newPage.className = s.className;
          newPage.style.display = '';
          newPage.appendChild(child);
          slidesWrap.appendChild(newPage);
          currentPage = newPage;
        } else {
          currentPage.style.display = '';
          if (!wasActive) currentPage.classList.remove('active');
        }
      });

      // Collect all pages from this section
      if (!allPages.includes(s)) allPages.push(s);
      if (!allPages.includes(currentPage) && currentPage !== s) allPages.push(currentPage);

      // Check for any additional sections we created between s and currentPage
      const allSecs = Array.from(slidesWrap.querySelectorAll(':scope > section')) as HTMLElement[];
      allSecs.forEach(sec => {
        if (!allPages.includes(sec)) allPages.push(sec);
      });
    });

    // Re-collect all sections after splitting
    const finalSections = Array.from(slidesWrap.querySelectorAll(':scope > section')) as HTMLElement[];

    let current = 0;
    const total = finalSections.length;

    // Build number buttons
    const numsContainer = document.getElementById('pg-nums');
    const numBtns: HTMLButtonElement[] = [];

    if (numsContainer && total > 1) {
      for (let i = 0; i < total; i++) {
        const btn = document.createElement('button');
        btn.className = 'pg-num';
        btn.textContent = String(i + 1);
        btn.addEventListener('click', () => show(i));
        numsContainer.appendChild(btn);
        numBtns.push(btn);
      }
    } else if (numsContainer) {
      numsContainer.style.display = 'none';
    }

    function updateNums() {
      numBtns.forEach((btn, i) => {
        btn.classList.toggle('pg-num--active', i === current);
      });
    }

    function show(index: number) {
      if (index < 0 || index >= total) return;

      finalSections.forEach((s) => s.classList.remove('active'));
      finalSections[index].classList.add('active');

      current = index;
      updateNums();
    }

    function goNextPage() {
      if (pages.length === 0) return;
      const nextIndex = (pageIndex + 1) % pages.length;
      window.location.href = pages[nextIndex];
    }

    function goPrevPage() {
      if (pages.length === 0) return;
      const prevIndex = (pageIndex - 1 + pages.length) % pages.length;
      window.location.href = pages[prevIndex];
    }

    function next() {
      if (current < total - 1) {
        show(current + 1);
      } else {
        goNextPage();
      }
    }

    function prev() {
      if (current > 0) {
        show(current - 1);
      } else {
        goPrevPage();
      }
    }

    // Initialize
    show(0);

    // Keyboard navigation
    document.addEventListener('keydown', (e: KeyboardEvent) => {
      if (e.key === 'ArrowRight' || e.key === ' ') { e.preventDefault(); next(); }
      if (e.key === 'ArrowLeft') { e.preventDefault(); prev(); }
    });

    // Prevent all scroll events globally
    window.addEventListener('wheel', (e) => { e.preventDefault(); }, { passive: false });
    window.addEventListener('touchmove', (e) => { e.preventDefault(); }, { passive: false });
  });
</script>
