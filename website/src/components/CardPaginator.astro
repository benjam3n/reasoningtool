---
// CardPaginator.astro — Card wrapping + in-place overflow pagination
// Groups content by headings into cards, then distributes cards across
// page sections by measuring overflow directly in the live DOM.
// Outputs <section> elements that Paginated.astro navigates.
---

<div class="card-paginator" data-card-paginator>
  <slot />
</div>

<script>
  document.addEventListener('astro:page-load', () => {
    const wrapper = document.querySelector('[data-card-paginator]') as HTMLElement;
    if (!wrapper) return;

    const slidesWrap = wrapper.closest('.paginated__slides') as HTMLElement;
    if (!slidesWrap) return;

    const originalSection = wrapper.closest('section') as HTMLElement;
    if (!originalSection) return;

    const content = wrapper.querySelector('.skill-page__content') as HTMLElement;
    if (!content) return;

    // --- Collect Astro scope attributes for cloning ---
    const astroAttrs: [string, string][] = [];
    Array.from(originalSection.attributes).forEach(attr => {
      if (attr.name.startsWith('data-astro-cid-')) {
        astroAttrs.push([attr.name, attr.value]);
      }
    });

    // --- Card wrapping: group by h2/h3 headings ---
    const children = Array.from(content.children) as HTMLElement[];
    if (children.length === 0) return;

    const cards: HTMLElement[] = [];
    let currentCard: HTMLElement | null = null;

    children.forEach((el) => {
      const tag = el.tagName.toLowerCase();
      if (tag === 'h1' || tag === 'hr') { el.remove(); return; }
      if (tag === 'h2' || tag === 'h3' || !currentCard) {
        currentCard = document.createElement('div');
        currentCard.className = 'content-card';
        cards.push(currentCard);
      }
      currentCard.appendChild(el);
    });

    if (cards.length === 0) return;

    // Detach header and footer
    const header = originalSection.querySelector('.skill-page__header') as HTMLElement;
    const footer = originalSection.querySelector('.skill-page__back') as HTMLElement;

    // --- Helpers ---
    function makeSection(): HTMLElement {
      const sec = document.createElement('section');
      sec.className = originalSection.className;
      astroAttrs.forEach(([n, v]) => sec.setAttribute(n, v));
      return sec;
    }

    function makeGrid(): HTMLDivElement {
      const g = document.createElement('div');
      g.className = 'content-card-grid';
      g.style.cssText = 'display:grid;grid-template-columns:repeat(3,1fr);grid-auto-rows:min-content;gap:var(--sp-2);width:100%;align-items:start;align-content:start;';
      return g;
    }

    function overflows(sec: HTMLElement): boolean {
      return sec.scrollHeight > sec.clientHeight;
    }

    function activate(sec: HTMLElement) {
      sec.classList.add('active');
      sec.style.display = 'block';
    }

    function deactivate(sec: HTMLElement) {
      sec.classList.remove('active');
      sec.style.display = '';
    }

    // --- Build first section in-place ---
    // Clear the original section and reuse it as page 1
    originalSection.innerHTML = '';
    activate(originalSection);

    if (header) originalSection.appendChild(header);
    let currentGrid = makeGrid();
    originalSection.appendChild(currentGrid);

    let currentPage = originalSection;
    const allSections: HTMLElement[] = [originalSection];

    // --- Add cards one at a time, check overflow ---
    for (const card of cards) {
      currentGrid.appendChild(card);

      if (overflows(currentPage)) {
        // This card caused overflow — move it to a new page
        // But if it's the only card in the grid, it's just oversized — leave it
        if (currentGrid.children.length > 1) {
          card.remove();

          // Start a new page
          deactivate(currentPage);
          const newPage = makeSection();
          slidesWrap.appendChild(newPage);
          activate(newPage);

          currentGrid = makeGrid();
          newPage.appendChild(currentGrid);
          currentGrid.appendChild(card);
          currentPage = newPage;
          allSections.push(newPage);
        }
        // else: single oversized card, leave it (will be clipped, no scroll)
      }
    }

    // --- Add footer to last page ---
    if (footer) {
      currentPage.appendChild(footer);

      // If footer caused overflow, move it (and optionally last card) to new page
      if (overflows(currentPage) && currentGrid.children.length > 0) {
        footer.remove();
        deactivate(currentPage);

        const newPage = makeSection();
        slidesWrap.appendChild(newPage);
        activate(newPage);

        // Move last card to footer page so it's not isolated
        const footerGrid = makeGrid();
        if (currentGrid.children.length > 0) {
          const lastCard = currentGrid.lastElementChild!;
          lastCard.remove();
          footerGrid.appendChild(lastCard);
          if (currentGrid.children.length === 0) currentGrid.remove();
        }
        newPage.appendChild(footerGrid);
        newPage.appendChild(footer);
        currentPage = newPage;
        allSections.push(newPage);
      }
    }

    // Deactivate all — Paginated.initNav will activate page 0
    allSections.forEach(s => deactivate(s));

    // Signal completion so Paginated can set up navigation
    document.dispatchEvent(new CustomEvent('card-paginator:done'));
  });
</script>
