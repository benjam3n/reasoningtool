---
import { getCollection, render } from 'astro:content';
import { ViewTransitions } from 'astro:transitions';
import Paginated from '../../components/Paginated.astro';
import CardPaginator from '../../components/CardPaginator.astro';
import '../../styles/global.css';
import fs from 'node:fs';
import path from 'node:path';

// Load tier data from skills.json at build time
const skillsJsonPath = path.resolve(
  new URL('.', import.meta.url).pathname,
  '../../../claude-code-plugin/skills.json'
);
const skillsRegistry = JSON.parse(fs.readFileSync(skillsJsonPath, 'utf-8')).skills as Record<string, { tier?: string }>;

const TIER_MAP: Record<string, { label: string; className: string }> = {
  tier1:        { label: 'Tier 1',        className: 'tier-1' },
  tier2:        { label: 'Tier 2',        className: 'tier-2' },
  tier3:        { label: 'Tier 3',        className: 'tier-3' },
  tier4:        { label: 'Tier 4',        className: 'tier-4' },
  category:     { label: 'Category',      className: 'tier-cat' },
  experimental: { label: 'Experimental',  className: 'tier-exp' },
};

export async function getStaticPaths() {
  const skills = await getCollection('skills');
  return skills.map((skill) => {
    const name = skill.id.replace(/\/SKILL$/i, '').replace(/\/skill$/i, '');
    return {
      params: { slug: name },
      props: { skill, name },
    };
  });
}

const { skill, name } = Astro.props;
const { Content } = await render(skill);

const rawTier = skillsRegistry[name]?.tier || 'tier4';
const { label: tier, className: tierClass } = TIER_MAP[rawTier] || TIER_MAP.tier4;
---

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content={skill.data.description} />
  <title>{skill.data.name} â€” reasoningtool</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <ViewTransitions />
</head>
<body>
  <Paginated>
    <section class="skill-page">
      <CardPaginator>
        <div class="skill-page__header">
          <span class:list={['tier-badge', tierClass]}>{tier}</span>
          <h1><code>{skill.data.name}</code></h1>
        </div>

        <article class="skill-page__content">
          <Content />
        </article>

        <nav class="skill-page__back">
          <a href="/" class="skill-back-btn">&larr; All skills</a>
          <button class="skill-github-btn pg-github" data-url={`https://github.com/benjam3n/reasoningtool/blob/main/claude-code-plugin/skills/${name}/SKILL.md`}>GitHub</button>
        </nav>
      </CardPaginator>
    </section>
  </Paginated>
</body>
</html>

<style>
  .skill-page__header {
    margin-bottom: var(--sp-1);
  }
  .skill-page__header .tier-badge {
    margin-bottom: var(--sp-1);
  }
  .skill-page__header h1 {
    font-size: var(--text-2xl);
    margin: 0;
  }
  .skill-page__header h1 code {
    background: none;
    padding: 0;
    font-size: inherit;
    color: inherit;
  }

  .skill-page__content {
    line-height: 1.65;
  }
  .skill-page__content :global(h1) {
    display: none;
  }
  .skill-page__content :global(h2) {
    font-size: var(--text-xl);
    margin-top: var(--sp-2);
    margin-bottom: var(--sp-1);
  }
  .skill-page__content :global(h3) {
    font-size: var(--text-lg);
    margin-top: var(--sp-2);
    margin-bottom: 0;
  }
  .skill-page__content :global(table) {
    font-size: var(--text-sm);
  }
  .skill-page__content :global(p) {
    margin-top: var(--sp-1);
    margin-bottom: var(--sp-1);
  }
  .skill-page__content :global(ul),
  .skill-page__content :global(ol) {
    margin-top: var(--sp-1);
    margin-bottom: var(--sp-1);
  }

  .skill-page__back {
    margin-top: var(--sp-3);
    padding-top: var(--sp-2);
    border-top: 1px solid var(--color-border);
    display: flex;
    align-items: center;
    gap: var(--sp-3);
  }

  .skill-back-btn,
  .skill-github-btn {
    display: inline-block;
    padding: 0.3em 0.7em;
    border: 1px solid var(--color-accent);
    border-radius: 4px;
    font-family: var(--font-sans);
    font-size: var(--text-xs);
    font-weight: 500;
    text-decoration: none;
    color: var(--color-accent);
    background: var(--color-accent-subtle);
    transition: background var(--transition), color var(--transition);
    cursor: pointer;
  }

  .skill-back-btn:hover,
  .skill-github-btn:hover {
    background: var(--color-accent);
    color: #fff;
    text-decoration: none;
  }
</style>
